# SPDX-FileCopyrightText: Copyright (c) 2022-2024 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: BSD-3-Clause
#
# BalenaOS adaptation of Nexcom ATC3750-8M flash configuration
# Original from: Nexcom ATC3750-8M BSP v4.1.5.0

# atc3750-8M-p3701-0000.conf: configuration for "ATC3750-8M + P3701"
# (T234 ATC3750-8M).

source "${LDK_DIR}/p3701-atc3750-8M.conf.common";

update_flash_args_atc3750_8m_p3701()
{
	# Select the Base DTB based on SKU for ATC3750-8M
	if [ "${board_sku}" = "0000" ]; then
		if [ "${board_FAB}" != "QS1" ]; then
			# Enable VRS11 DCM mode for CPU/GPU/CV rails
			PMIC_CONFIG="tegra234-mb1-bct-pmic-p3701-0005.dts";
		fi
		# Default DTB for unknown SKU (fallback)
		DTB_FILE=tegra234-p3737-0000+p3701-0000-nv.dtb;
	elif [ "${board_sku}" = "0001" ] || [ "${board_sku}" = "0002" ]; then
		# Standard configuration
		DTB_FILE=tegra234-p3737-0000+p3701-0000-nv.dtb;
	elif [ "${board_sku}" = "0004" ]; then
		# ATC3750-8M 32GB variant configuration
		# Enable VRS11 DCM mode for CPU/GPU/CV rails
		PMIC_CONFIG="tegra234-mb1-bct-pmic-p3701-0005.dts";
		echo -e "[ATC3750-8M] Board SKU = 0004, AGX Orin 32GB variant detected"
		TBCDTB_FILE=tegra234-p3701-0004-atc3750-8M-base_ver.dtb;
		DTB_FILE=tegra234-p3701-0004-atc3750-8M-base_ver.dtb;
	elif [ "${board_sku}" = "0005" ]; then
		# ATC3750-8M 64GB variant configuration
		# Enable VRS11 DCM mode for CPU/GPU/CV rails
		PMIC_CONFIG="tegra234-mb1-bct-pmic-p3701-0005.dts";
		echo -e "[ATC3750-8M] Board SKU = 0005, AGX Orin 64GB variant detected"
		DTB_FILE=tegra234-p3701-0005-atc3750-8M-base_ver.dtb;
		TBCDTB_FILE=tegra234-p3701-0005-atc3750-8M-base_ver.dtb;
	else
		echo "Error: Unrecognized ATC3750-8M module SKU ${board_sku}";
		exit 1;
	fi

	echo -e "[ATC3750-8M] DTB FILE: ${DTB_FILE}"
	echo -e "[ATC3750-8M] TBCDTB FILE: ${TBCDTB_FILE}"
	echo -e "[ATC3750-8M] PINMUX CONFIG: ${PINMUX_CONFIG}"
}

# update_flash_args:
update_flash_args()
{
	update_flash_args_common
	update_flash_args_atc3750_8m_p3701
}

# Default DTB configuration
DTB_FILE=tegra234-p3737-0000+p3701-0000-nv.dtb;
TBCDTB_FILE="${DTB_FILE}";

# ATC3750-8M specific overlay configuration
# Disable camera overlays for ATC3750-8M (industrial use case)
OVERLAY_DTB_FILE="L4TConfiguration.dtbo,tegra234-p3737-0000+p3701-0000-dynamic.dtbo,tegra234-carveouts.dtbo,tegra-optee.dtbo";